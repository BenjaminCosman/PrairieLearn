{{#grader}}
<div class="my-3 p-2 border rounded 
            {{^needs_grading}} border-success {{/needs_grading}}
            {{#needs_grading}} border-warning {{/needs_grading}}" 
            id="pl-manual-{{uuid}}">
        <button id="pl-manual-regrade-button-{{uuid}}" type="button"
            class="btn btn-light border d-flex pl-manual-regrade-button" 
            data-placement="right" data-toggle="popover" data-html="true" 
            title="Regrade {{answer_name}}" data-content="{{popover_html}}" 
            data-trigger="manual" tabindex="0" onclick="$(this).popover('show')">
                <svg class="svg-inline--fa fa-edit fa-w-18" aria-hidden="true" focusable="false" data-prefix="fa" data-icon="edit" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M402.6 83.2l90.2 90.2c3.8 3.8 3.8 10 0 13.8L274.4 405.6l-92.8 10.3c-12.4 1.4-22.9-9.1-21.5-21.5l10.3-92.8L388.8 83.2c3.8-3.8 10-3.8 13.8 0zm162-22.9l-48.8-48.8c-15.2-15.2-39.9-15.2-55.2 0l-35.4 35.4c-3.8 3.8-3.8 10 0 13.8l90.2 90.2c3.8 3.8 10 3.8 13.8 0l35.4-35.4c15.2-15.3 15.2-40 0-55.2zM384 346.2V448H64V128h229.8c3.2 0 6.2-1.3 8.5-3.5l40-40c7.6-7.6 2.2-20.5-8.5-20.5H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V306.2c0-10.7-12.9-16-20.5-8.5l-40 40c-2.2 2.3-3.5 5.3-3.5 8.5z"></path></svg><!-- <i class="fa fa-edit" aria-hidden="true"></i> -->
        </button>
        <input type="hidden" name="{{ answer_name }}-points" 
                id="pl-manual-points-{{ uuid }}" value="{{ score }}">
        <input type="hidden" name="{{ answer_name }}-feedback" 
                id="pl-manual-feedback-{{ uuid }}" value="{{ feedback }}">
    <div id="pl-manual-children-{{uuid}}">
      {{#children}}
        {{{html}}}
      {{/children}}
    </div>
</div>
<script>
$(() => {
    const uuid = "{{uuid}}";

    $(`#pl-manual-regrade-button-${uuid}`).popover({
      sanitize: false, 
      container: 'body'
    });

    $(`#pl-manual-children-${uuid} input`).prop("disabled", true);
    
    $(`#pl-manual-${uuid}`)
    .closest('form')
    .on('submit', () => {
      // This should be a sum out of 100 (percentage)
      let points = 0;
      let feedback = [];

      // Iterate over children and grab out appropriate values
      // TODO: Augment so we can persist the state of certain children instead of only
      //        passing on a single point/feedback value
      // SPIKE: Figure out what anchors to give to children and validate uniqueness in pl-manual.py
      $(`#pl-manual-${uuid}`)
        .children('input')
        .toArray()
        .forEach((child) => {
          const val = child.getAttribute('value');
          const field = child.getAttribute('name');
          switch (field) {
            case 'points':
              points += parseInt(val);
            case 'feedback':
              feedback.push(val);
              break;
            default:
              throw new Error(
                `Unable to attribute field "${field}" to a score.`
              );
          }
        });

      // FIXME: Remove demo logging
      console.log(uuid, points, feedback);

      // These are the actual fields that the form submission will take a look at
      $(`#pl-manual-points-${uuid}`).attr('value', points / 100);
      $(`#pl-manual-feedback-${uuid}`).attr('value', JSON.stringify(feedback));
    });
});
</script>
{{/grader}}

{{#student}}
<div>
  {{{html}}}
  <p>
    {{#needs_grading}}This part of the question may be manually graded by an instructor.{{/needs_grading}}
    {{^needs_grading}}This part of the question has already been manually graded by an instructor.{{/needs_grading}}
  </p>
</div>
{{/student}}

{{#popover}}
<div>
    {{#use_default_popover_body}}
      <div class="form-group">
          <span class="input-group-prepend">
            <span class="input-group-text">Score %:</span>
          </span>
          <input type="number" min="0" max="100" 
                  class="form-control" name="points" 
                  value="{{ score }}">
          <span class="input-group-prepend">
            <span class="input-group-text">Feedback:</span>
          </span>
          <input type="text" class="form-control" name="feedback"
                  value="{{ feedback }}"/>
          <p><small>This will adjust the total percentage earned for this question part (i.e. partial).
                  Future changes to the student's score will override this value.</small></p>
          </div>
      </div>
    {{/use_default_popover_body}}
    <div>
      {{#popover_contents}}
        {{{html}}}
      {{/popover_contents}}
    </div>
    <button type="button" class="btn btn-primary" onclick="$(`#pl-manual-regrade-button-{{uuid}}`).popover(`hide`)">Close and Continue</button>
</div>
{{/popover}}
